# 공통 (default)
server:
  port: ${PORT:8000}

spring:
  application:
    name: gateway-server
  cloud:
    gateway:
      routes:
        - id: budget-server-route
          uri: lb://budget-server
          predicates:
            - Path=/budget/**
        - id: budget-server-apidocs
          uri: lb://budget-server
          predicates:
            - Path=/apidocs/budget-server/**
          filters:
            # 주의: ${segment}는 YAML에서 EL로 인식되므로 백슬래시로 이스케이프 필요
            - RewritePath=/apidocs/budget-server/(?<segment>.*), /docs/\${segment}

# Eureka 기본값은 localhost이지만, 환경변수로 덮어쓰기 가능하게 처리
# 우선순위: EUREKA_SERVER_URL > EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE > localhost
# 예) https://eureka-server-xxxxx.onrender.com/eureka/
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:${EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE:http://localhost:8761/eureka/}}

# 게이트웨이에서 사용하는 시크릿(필수)
gateway:
  secret: ${GATEWAY_SECRET}

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  metrics:
    tags:
      application: ${spring.application.name}

# 로컬 개발용 상세 로그
yml_logging_local:
  level:
    org.springframework.cloud.gateway: TRACE
    reactor.netty.http.client: DEBUG
    reactor.netty.http.server: DEBUG

---

# prod (Render)
spring:
  config:
    activate:
      on-profile: prod

eureka:
  instance:
    # 1. Render 내부 서비스 이름(Service Name)을 호스트명으로 사용
    hostname: gateway-server

    # 2. IP 대신 호스트명(도메인)을 우선 사용하도록 설정 (중요)
    prefer-ip-address: false

    # 3. 중요: 내부 통신은 HTTP(8000)를 사용하므로 secure 관련 설정 제거 또는 false
    non-secure-port: ${PORT:8000}
    non-secure-port-enabled: true
    secure-port-enabled: false

    # 4. 헬스 체크 경로 명시 (HTTPS 프로토콜 사용)
    status-page-url: http://${eureka.instance.hostname}:${server.port}/actuator/info
    health-check-url: http://${eureka.instance.hostname}:${server.port}/actuator/health
    home-page-url: http://${eureka.instance.hostname}:${server.port}/

# prod에서는 과도한 디버그를 줄이고 INFO 중심으로 설정
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO
    reactor.netty.http.client: INFO
    reactor.netty.http.server: INFO